from aiogram import Router
from aiogram.types import Message, FSInputFile
from aiogram.filters import Command
from database.models import db
from utils.reporter import generate_html_report
from config.settings import settings

router = Router()

@router.message(Command("stats"))
async def handle_stats_command(message: Message):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∞—Ä–µ–Ω–¥–∞–º"""
    if message.from_user.id not in settings.ADMIN_IDS:
        await message.reply("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞—Ä–µ–Ω–¥—ã
        rentals = db.get_all_rentals()
        
        if not rentals:
            await message.reply("üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞—Ä–µ–Ω–¥–∞—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.")
            return
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –æ—Ç—á–µ—Ç
        filename = await generate_html_report(rentals)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
        document = FSInputFile(filename)
        await message.answer_document(
            document,
            caption="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä–µ–Ω–¥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"
        )
        
    except Exception as e:
        await message.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.")